= ASAM Standard Workflows

IMPORTANT: 28.04.2021: See https://code.asam.net/simulation/standard/openscenario-2.0/-/wikis/docs/git/Transitioning-to-a-new-workflow[Transitioning to the new Workflow] for steps we need to take to enable this workflow

=== Workflow Overview

.OSC2 Workflow Stages
[mermaid]
....
graph LR
ISSUE
--> ANALYSIS
--> IMPLEMENTATION
--> REVIEW
--> INTEGRATION
--> MERGE;
....


=== Branch Structure

image::../images/2021-04-15_OSC2_RevisedWorkflow-Diagram_v5-Page-2.png[]

2 primary project branches:

[horizontal]
release:: Content that has been subjected to the following:

+
. Review by the full project group and the Implementers Forum
. Integration by the service provider
. Review by the CCB 

+
This branch can only be merged to by the ASAM office or the project's Change Control Board (CCB). Unless indicated by a clear git tag all commits are considered to be part of a release candidate.

master:: (default branch) All development activity takes place on this branch. 


Users MAY branch off master for more focused development work. These branches SHOULD be short-lived (<2 weeks) and regularly merged back. These branches MAY be squashed and MUST be merged via fast-forward merge (enabled by default).

== ASAM OSC2 Commit Message Convention

See https://code.asam.net/simulation/standard/openscenario-2.0/-/wikis/docs/git/Commit-Guidelines[here]

== Project Workflow

NOTE: ``Code snippets`` are https://code.asam.net/help/user/project/quick_actions[GitLab quick actions] that can be used directly in comments. 

[IMPORTANT]
====
All included document fragments to date have been encapsulated in a draft 'feature flag'. 
[source]
----
\ifdef::draft[include::document_subsection.adoc[]]
----
The content encapsulated in the square brackets is only included if the ``draft`` attribute is set.

This allows us to have both a draft document and a reviewed document from the same source through just adding or removing the ``draft`` attribute in the build pipeline.

To convert content to reviewed (i.e. non draft) content, the encapsulating ifdef statement simply needs to be removed (everything that is not in the square brackets).

These flags SHOULD only be modified by WG Leads, the CCB or the ASAM office.

You may experience an empty preview in your editor when editing files that contain the mechanism.
This is actually a good sign. The preview is working correctly and hides all parts marked as draft.

To make the parts visible again, you have to set the attribute `draft` for your preview window.

**Solution for VisualStudioCode with Asciidoc extension:**

1. In the Asciidoc extension settings go to `Preview:Attributes - Edit in settings.json`.
2. In the settings.json add the `draft` attribute:

        "asciidoc.preview.attributes": {
            "draft": ""
        }

3. Save settings.json

**Solution for AsciidocFX preview:**

1. Go to `Settings` on the right hand side of the preview
2. Go to the `Preview settings` tab
3. Add an `Asciidoctor Attribute` by double-clicking an empty attribute line
4. Add attribute `draft` with value `true`
5. Save the settings (small button on the lower left of the tab!)
6. Reload the preview

**Solution for Gitlab preview:**

The preview in Gitlab intentionally shows the release version of the files, meaning that the parts marked as draft are hidden.

You can easily switch off the preview and view the source content by clicking on the `display source`-icon on top of the file window:

image::../images/source_view.png[]

The icon next to it switches back to the preview.


====

[NOTE]
====
Please note that all the previews described above are just for your convenience. 
The only reliable documents for reviews are the _**html-artifacts**_ generated by the CI-pipeline. 
These artifacts are linked at the beginning of review merge requests.
You can also download the artifacts directly from the pipeline result page.
====


=== INITIAL SETUP

*Who: WG Leads*

. Create issues that map to the features in the project list
. Assign the issues to the correct milestone: ``/milestone <milestone>``
. Assign the issues to a responsible: ``/assign @<user>``



=== ANALYSIS

*Who: Issue Assignee*

. Coordinate & drive the preparation of a proposal for addressing the issue. Either via comments or in further meetings. 
. ``/label ~Analysis`` to indicate this issue is being looked at and discussed.

=== IMPLEMENTATION

*Who: Issue Assignee*

. Once a proposal is ready to be implemented, begin submitting work via commits to the develop branch
. [OPTIONAL] An assignee MAY create a separate branch off of _develop_ to make it easier to keep development separate. Such a branch SHOULD be short-lived (no more than 2 weeks) to ensure progress and direction are visible to project members and that it is not too out of sync with other activities.
. Change the issue status ``/label ~Implementation`` to indicate that a proposal is being implemented for this issue

=== REVIEW



*Who: WG Lead*

. Review implementation progress of issue in WG meetings
. Once the group agrees that the feature is complete:
.. [PREREQUISITE] If a feature branch was created, it MUST have been merged to develop
.. Change the issue status ``/label ~ProjectReview`` 
.. Create a new branch from develop
.. Remove the encapsulating draft feature flag from the content (make sure that all other content remains within the draft flag) and commit the change. 
.. Open a MR to develop, add a comment to request review by the whole project and the implementers forum: ``/request_review @all``. The MR MUST include document subsection number(s) being reviewed and a link to the lines of source code to be reviewed.

*Who: All project members & Implementers Forum*

. Submit feedback on the changes directly in the MR
* General Feedback: Submit a comment on the MR
* Content specific: Start a review in the changes tab of the MR

+
NOTE: To start a review, write a comment on a diff as normal under the Changes tab in a merge request, and then select Start a review. Click https://docs.gitlab.com/ee/user/discussions/#starting-a-review[here] for more information.

* If the review feedback requires further development work, the process restarts from the <<IMPLEMENTATION>> stage

.A demo of a review
image::../images/ReviewExample.gif[]

*Who: CCB*

. If there are no unresolved comments or threads after two weeks the CCB ends the review.
. The MR is assigned to the service provider for integration 
.. ``/assign @amuetsch``

=== INTEGRATION

. The service provider (SP) refines the content in the MR: 
.. Change status to ``/label ~Integration``
* The content is adjusted to adhere to ASAM style and writing conventions
* General editorial rewrites to ensure homogeneity of content


+
IMPORTANT: Questions on content should be addressed to the original issue assignee who will be responsible for ensuring a satisfactory resolution. In the case that questions lead to significant changes to the content, the MR is reopened for review on resolution.

* On completion of the integration:
.. Create a 2nd MR from the review branch to release (same MR title)
.. Add ``/label ~CCBReview`` to both MRs
.. Both MRs MUST be set to squash commits with fast-forward merging (default).
.. Squash commit message MUST adhere to the commit conventions

=== MERGE

*Who: CCB*

. CCB performs a final review of the integrated content
* Is the original content still correctly represented?
* Are all guidelines & conventions maintained?
* Are all discussions resolved?
. CCB merges the MRs to ``develop`` and ``release``


---
### Further Repository Guidelines
- link:docs/git/Commit-Guidelines.adoc[Commit Message Guidelines] -  Formatting guidelines for commit messages on commits/merges to the ASAM master branches
- link:docs/git/Branching.adoc[Branching]
- link:docs/git/Forking.adoc[Forking]
- link:docs/tool-specific/VSCode-Guide.adoc[VSCode at ASAM]