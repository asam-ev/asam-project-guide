= Adding VSCode Support For Diagrams With Kroki
:imagesdir: ../images

The kroki extension supports a wide range of diagrams from BPMN to Graphviz to PlantUML and Vega graphs using kroki and asciidoctor-kroki.

You can see the full range and examples on the https://kroki.io/examples.html[website].

== Enabling Kroki Support In AsciiDoc

The AsciiDoc extension for Visual Studio Code (see xref:Recommended-VSCode-Extensions.adoc#AsciiDoc[Recommended Visual Studio Code Extensions]) comes with the ability to include Kroki diagrams. However, it is deactivated by default and must be configured before first use.

This requires a diagram server. There are multiple options:

. use the public kroki.io server
. deploy your own server
. https://docs.kroki.io/kroki/setup/install/[run a kroki docker container] on your local machine

We will go with option 1.

WARNING: This extension will send graph information to https://kroki.io. If this is an issue, it is also possible to use your own kroki instance (see https://docs.kroki.io/kroki/setup/install/[here for more information]).

To enable diagram support, set the use_kroki parameter in your User Settings to true.

image::enable_kroki.gif[Enabling Kroki diagram support in AsciiDoc extension]
 
. Open the Command Palett (`Ctrl`+ `Shift` + `P`)
. Type "user settings" and confirm with Enter
. Search for "kroki" in the user settings and enable the "Use_kroki" checkbox


== Caching Diagrams Locally

NOTE: This is a per-file setting and must be done in each applicable AsciiDoc file.

By default, diagrams are not saved locally. To cache and save diagrams locally, set the kroki-fetch-diagram attribute in your document header:

    = My Amazing Document
    :kroki-fetch-diagram:

This will store images by default in your document folder. However, you may also set `imagesdir` to store them elsewhere:

    = My Amazing Document
    :kroki-fetch-diagram:
    :imagesdir: media

The images are served over http:// and you must allow your preview to include data from unsafe sources. To do this, open your command palette (ctrl+shift+P) and enter ``asciidoc preview security`` and choose ``Allow insecure content``. 

NOTE: Access to this global setting is only available if you have currently are in an AsciiDoc file in VSCode. Otherwise, the setting will not show up.

.opening asciidoc preview security settings
image::plantuml_1.png[]

.allow insecure content
image::plantuml_2.png[]

== Testing Kroki Examples

With the settings done and caching activated, you can test Kroki with the following examples:

[cols="1h,4,4"]
|===
|PlantUML
a|
[source,asciidoc]
----
[plantuml,puml,svg]
....
@startuml
node "Test1" as tst1
node "Test2" as tst2
tst1 --> tst2: caption
@enduml
....
----
a|image::plantuml_3.png[]

|Gantt Diagram
a|
---- 
[mermaid]
....
gantt
    title A Gantt Diagram
    dateFormat  YYYY-MM-DD
    section Section
    A task           :a1, 2014-01-01, 30d
    Another task     :after a1, 20d
    section Another
    Task in sec      :2014-01-12, 12d
    another task     :24d
....  
----  
a|image::gannt_example.png[]

|Pie Diagram
a|
----
[mermaid]
....
pie title Pets adopted by volunteers
    "Dogs" : 386
    "Cats" : 85
    "Rats" : 15
            
....
----
a|image::pie_example.png[]
a|
----
[mermaid]
....
graph TD
    A[Christmas] --> B(Go shopping)
    B --> C{Let me think}
    C --> D[Laptop]
    C --> E[iPhone]
....
----
a|image::flow_example.png[]
|===
